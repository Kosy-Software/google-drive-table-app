(()=>{"use strict";(()=>{function e(e,t){let i=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0),o=i.querySelector("iframe");return o.src=e.googleDriveUrl,o.style.height=`${window.innerHeight}px`,i}const t=new RegExp("^(https://[a-zA-Z]+.google.com");function i(e){return e&&t.test(e)}function o(e,t){let o=document.querySelector("#picking").content.cloneNode(!0),n=o.querySelector("input"),s=o.querySelector("#open-file");return n.oninput=e=>{i(n.value)?(s.removeAttribute("disabled"),n.style.color="black"):(s.setAttribute("disabled","disabled"),n.style.color="red")},s.onclick=e=>{let i=n.value;t({type:"google-drive-url-changed",payload:i})},o.querySelector("#open-picker").onclick=e=>{return i=this,o=void 0,s=function*(){t({type:"file-picker-opened",payload:{}})},new((n=void 0)||(n=Promise))((function(e,t){function l(e){try{a(s.next(e))}catch(e){t(e)}}function r(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(l,r)}a((s=s.apply(i,o||[])).next())}));var i,o,n,s},o}function n(e,t){let i=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return i.querySelector("label").innerHTML=`${e.initializer.clientName} is picking a file to share`,i}class s{constructor(e){this.kosyClient=window.parent,this.kosyApp=e}startApp(){return new Promise(((e,t)=>{window.addEventListener("message",(i=>{let o=setTimeout((()=>{t(),this._sendMessageToKosy({type:"stop-app",payload:{}})}),1e4),n=i.data;switch(n.type){case"receive-initial-info":clearTimeout(o),e(n.payload);break;case"client-has-joined":this.kosyApp.onClientHasJoined(n.payload);break;case"client-has-left":this.kosyApp.onClientHasLeft(n.payload);break;case"request-app-state":const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",payload:t});break;case"receive-message":this.kosyApp.onReceiveMessage(n.payload)}})),this._sendMessageToKosy({type:"ready-and-listening",payload:{}})}))}stopApp(){this._sendMessageToKosy({type:"stop-app",payload:{}})}relayMessage(e){this._sendMessageToKosy({type:"relay-message",payload:e})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}}var l;!function(t){var l;(function(t){class l{constructor(){this.kosyApi=new s({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessage:e=>this.processMessage(e),onRequestState:()=>this.getState()}),this.state={googleDriveUrl:null}}start(){var e,t,i,o,n;return t=this,i=void 0,n=function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentIntegrationState)&&void 0!==e?e:this.state,this.renderComponent()},new((o=void 0)||(o=Promise))((function(e,s){function l(e){try{a(n.next(e))}catch(e){s(e)}}function r(e){try{a(n.throw(e))}catch(e){s(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(l,r)}a((n=n.apply(t,i||[])).next())}))}getState(){return this.state}onClientHasJoined(e){}onClientHasLeft(e){e.clientUuid!==this.initializer.clientUuid||this.state.googleDriveUrl||this.kosyApi.stopApp()}processMessage(e){switch(e.type){case"receive-google-drive-url":i(e.payload)&&(this.state.googleDriveUrl=e.payload,this.renderComponent())}}processComponentMessage(e){switch(e.type){case"google-drive-url-changed":this.kosyApi.relayMessage({type:"receive-google-drive-url",payload:e.payload});break;case"file-picker-closed":if(this.state.googleDriveUrl)break;e.payload.googleDriveUrl?(this.log("Google drive url picked: ",e.payload.googleDriveUrl),this.processComponentMessage({type:"google-drive-url-changed",payload:e.payload.googleDriveUrl})):(this.log("No google drive url picked, ending integration"),this.kosyApi.stopApp());break;case"file-picker-opened":this.log("The file picker was opened"),function(e,t){const i=window.outerWidth/2+window.screenX-t.width/2,o=window.outerHeight/2+window.screenY-t.height/2;let n=window.open("picker.html","_blank",`fullscreen=0,menubar=0,location=0,directories=0,toolbar=0,titlebar=0,width=${t.width},height=${t.height},top=${o},left=${i}`);if(t.onclose)var s=setInterval((()=>{n.closed&&(clearInterval(s),t.onclose())}),1e3)}(0,{onclose:()=>this.processComponentMessage({type:"file-picker-closed",payload:{}}),width:1024,height:1024})}}renderComponent(){!function(t,i){let s;s=(null==t?void 0:t.googleDriveUrl)?e:t.currentClient.clientUuid==t.initializer.clientUuid?o:n;let l=document.getElementById("root");var r=l.cloneNode(!1);l.parentNode.replaceChild(r,l),r.appendChild(s(t,i))}({googleDriveUrl:this.state.googleDriveUrl,currentClient:this.currentClient,initializer:this.initializer},(e=>this.processComponentMessage(e)))}log(...e){var t,i;console.log(`${null!==(i=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==i?i:"New user"} logged: `,...e)}}t.App=l,(new l).start()})((l=t.Integration||(t.Integration={})).GoogleDrive||(l.GoogleDrive={}))}(l||(l={}))})()})();