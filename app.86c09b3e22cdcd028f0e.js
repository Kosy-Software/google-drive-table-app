(()=>{"use strict";(()=>{const e=JSON.parse('{"l":{"x":"616819909997-uh4gnbl6pjhu4p8ic3vrgof49vejr5nn.apps.googleusercontent.com"}}');var t=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};const i=new RegExp("^(https://\\w+.google.com)"),n=new RegExp("^(https://(drive|docs).google.com)","i"),o=new RegExp("/d/([-\\w]{25,})");const s=new Date("1970-01-01T00:00:00Z").getTime();function r(e){return t(this,void 0,void 0,(function*(){let i=JSON.parse(localStorage.getItem("google_access_token")||"{}");return new Date(s+((null==i?void 0:i.expires_at)||0)-6e4)<new Date&&(i=yield function(e){return t(this,void 0,void 0,(function*(){return yield c("auth2"),yield a((t=>new Promise(((i,n)=>{try{let o=t.currentUser.get();o.hasGrantedScopes(e)?i(o.getAuthResponse(!0)):t.signIn().then((e=>i(e.getAuthResponse(!0)))).catch((e=>n(e)))}catch(e){n()}}))))}))}(e),localStorage.setItem("google_access_token",JSON.stringify(i))),i}))}function a(t,i){return gapi.auth2.init({client_id:e.l.x,scope:i}).then((()=>t(gapi.auth2.getAuthInstance())))}function l(){return t(this,void 0,void 0,(function*(){return yield c("auth2"),a((e=>e.isSignedIn.get()))}))}function c(e){return t(this,void 0,void 0,(function*(){return new Promise(((t,i)=>gapi.load(e,{callback:()=>t({}),onerror:()=>i(),timeout:5e3,ontimeout:()=>i()})))}))}function d(e,t){let i=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0),s=i.querySelector("iframe");return s.style.height="100vh",s.style.width="100vw",s.src=(r=e.googleDriveUrl,n.test(r)?r.replace("/view","/preview"):`https://drive.google.com/file/d/${function(e){let t=e.match(o);return t&&t.length>1?t[1]:null}(r)}/preview`),i;var r}var u=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};function h(e,t){let n=document.querySelector("#picking").content.cloneNode(!0),o=n.querySelector("input"),s=n.querySelector("#open-file"),r=n.querySelector("#validation-error");if(e.validationResponse.error){switch(e.validationResponse.error){case"NotShared":r.innerHTML=`The file is not shared. Please click <a href="${function(e){let t=new URL(e.replace("/preview","/edit"));return t.searchParams.append("userstoinvite","@"),t.toString()}(e.validationResponse.url)}" target="_blank">here</a> to enable file sharing.`}o.style.color="red"}return o.value=e.validationResponse.url,o.oninput=e=>{const t=o.value;var n;o.classList.remove("invalid"),o.classList.remove("valid"),s.classList.remove("valid"),r.innerHTML="",t&&((n=t)&&i.test(n)?(s.removeAttribute("disabled"),s.classList.add("valid"),o.classList.add("valid")):(s.setAttribute("disabled","disabled"),o.classList.add("invalid")))},s.onclick=e=>u(this,void 0,void 0,(function*(){let e={url:o.value};t({type:"google-drive-validation-changed",payload:e})})),n.querySelector("#open-picker").onclick=e=>u(this,void 0,void 0,(function*(){t({type:"file-picker-opened",payload:{}})})),n}function p(e,t){let i=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0),n=i.querySelector("label"),o=i.querySelector(".login");return n.innerHTML=e.googleDriveUrl?`${e.initializer.clientName} has picked a file to share,<br/>please log in with google to view it`:`${e.initializer.clientName} is picking a file to share`,e.userIsSignedIntoGoogle?o.remove():o.onclick=()=>r().catch((()=>Promise.resolve())).then((()=>t({type:"authenticated-with-google"}))),i}function g(e,t){let i=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0),n=i.querySelector("label"),o=i.querySelector(".login");return n.innerHTML="To start sharing a file, please log in with google",o.onclick=()=>r().catch((()=>Promise.resolve())).then((()=>t({type:"authenticated-with-google"}))),i}class v{constructor(e){this.kosyClient=window.parent,this.kosyApp=e}startApp(){return new Promise(((e,t)=>{window.addEventListener("message",(t=>{let i=t.data;switch(i.type){case"receive-initial-info":e(i.payload);break;case"client-has-joined":this.kosyApp.onClientHasJoined(i.payload);break;case"client-has-left":this.kosyApp.onClientHasLeft(i.clientUuid);break;case"get-app-state":const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",payload:t,clientUuids:i.clientUuids});break;case"set-app-state":this.kosyApp.onProvideState(i.state);break;case"receive-message":this.kosyApp.onReceiveMessage(i.payload)}})),this._sendMessageToKosy({type:"ready-and-listening"})}))}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this._sendMessageToKosy({type:"relay-message",payload:e})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}}var y,f=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};!function(e){var t;(function(e){class t{constructor(){this.state={googleDriveUrl:null},this.kosyApi=new v({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessage:e=>{this.processMessage(e)},onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e;return f(this,void 0,void 0,(function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))}))}getState(){return this.state}setState(e){this.state=e,this.renderComponent()}onClientHasJoined(e){}onClientHasLeft(e){e!==this.initializer.clientUuid||this.state.googleDriveUrl||this.kosyApi.stopApp()}processMessage(e){return f(this,void 0,void 0,(function*(){switch(e.type){case"receive-google-drive-url":this.log("Received a message from Kosy: ",e),this.state.googleDriveUrl=e.payload,yield this.renderComponent()}}))}processComponentMessage(e){return f(this,void 0,void 0,(function*(){switch(e.type){case"file-picker-opened":this.log("Open the file picker"),function(e,t){const i=window.outerWidth/2+window.screenX-t.width/2,n=window.outerHeight/2+window.screenY-t.height/2;window.open("picker.html","_blank",`fullscreen=0,menubar=0,location=0,directories=0,toolbar=0,titlebar=0,width=${t.width},height=${t.height},top=${n},left=${i}`)}(0,{width:1024,height:1024});break;case"google-drive-validation-changed":let t=e.payload;this.validationResponse=t,t.error?this.renderComponent():this.kosyApi.relayMessage({type:"receive-google-drive-url",payload:t.url});break;case"authenticated-with-google":this.renderComponent()}}))}renderComponent(){var e;return f(this,void 0,void 0,(function*(){!function(e,t){let i=function(e){return e.googleDriveUrl&&e.userIsSignedIntoGoogle?d:e.currentClient.clientUuid==e.initializer.clientUuid?e.userIsSignedIntoGoogle?h:g:p}(e),n=document.getElementById("root");var o=n.cloneNode(!1);n.parentNode.replaceChild(o,n),o.appendChild(i(e,t))}({googleDriveUrl:this.state.googleDriveUrl,userIsSignedIntoGoogle:yield l(),currentClient:this.currentClient,initializer:this.initializer,validationResponse:null!==(e=this.validationResponse)&&void 0!==e?e:{url:""}},(e=>this.processComponentMessage(e)))}))}log(...e){var t,i;console.log(`${null!==(i=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==i?i:"New user"} logged: `,...e)}}e.App=t,(new t).start()})((t=e.Integration||(e.Integration={})).GoogleDrive||(t.GoogleDrive={}))}(y||(y={}))})()})();