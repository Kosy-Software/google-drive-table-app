(()=>{"use strict";(()=>{function e(e,t){let i=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0),n=i.querySelector("iframe");return n.style.height=`${window.innerHeight}px`,n.src=e.googleDriveUrl,i}const t=JSON.parse('{"l":{"c":"AIzaSyDFUoIEXWGk0NPtqPjCadqnEpcgxydw9ko","x":"1055348097262-m31jmp68886tmq7hmsa7pgg0fopb9dot.apps.googleusercontent.com"}}');var i=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function l(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((n=n.apply(e,t||[])).next())}))};const n=new RegExp("^(https://\\w+.google.com)"),o=new RegExp("/d/([-\\w]{25,})");function s(e){return i(this,void 0,void 0,(function*(){if(!e)return null;let n=yield function(){return i(this,void 0,void 0,(function*(){let e=JSON.parse(localStorage.getItem("google_access_token")||"{}");return new Date(l+((null==e?void 0:e.expires_at)||0)-6e4)<new Date&&(e=yield function(e){return i(this,void 0,void 0,(function*(){return yield a("auth2"),yield new Promise(((t,i)=>{try{gapi.auth2.init({client_id:e,scope:r,fetch_basic_profile:!1});let o=gapi.auth2.getAuthInstance();var n=o.currentUser.get();n.hasGrantedScopes(r)?t(n.getAuthResponse(!0)):o.signIn().then((e=>t(e.getAuthResponse(!0)))).catch((e=>i(e)))}catch(e){i()}}))}))}(t.l.x),localStorage.setItem("google_access_token",JSON.stringify(e))),e}))}();if(!n)return null;yield a("client"),gapi.client.setApiKey(t.l.c),gapi.client.setToken({access_token:n.access_token});try{let t=yield gapi.client.request({path:`https://www.googleapis.com/drive/v3/files/${e}?fields=webViewLink`}),i=JSON.parse((null==t?void 0:t.body)||"{}").webViewLink;if(i)return i.startsWith("https://jamboard.google.com")?`https://drive.google.com/file/d/${e}/preview`:i.replace("/view","/preview")}catch(e){return null}}))}const r="https://www.googleapis.com/auth/drive.file",l=new Date("1970-01-01T00:00:00Z").getTime();function a(e){return i(this,void 0,void 0,(function*(){return new Promise(((t,i)=>gapi.load(e,{callback:()=>t({}),onerror:()=>i(),timeout:5e3,ontimeout:()=>i()})))}))}function c(e,t){let i=document.querySelector("#picking").content.cloneNode(!0),s=i.querySelector("input"),r=i.querySelector("#open-file");return s.oninput=e=>{var t;(t=s.value)&&n.test(t)?(r.removeAttribute("disabled"),s.style.color="black"):(r.setAttribute("disabled","disabled"),s.style.color="red")},r.onclick=e=>{let i=function(e){let t=e.match(o);return t&&t.length>1?t[1]:null}(s.value);t({type:"google-drive-file-id-changed",payload:i})},i.querySelector("#open-picker").onclick=e=>{return i=this,n=void 0,s=function*(){t({type:"file-picker-opened",payload:{}})},new((o=void 0)||(o=Promise))((function(e,t){function r(e){try{a(s.next(e))}catch(e){t(e)}}function l(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(r,l)}a((s=s.apply(i,n||[])).next())}));var i,n,o,s},i}function d(e,t){let i=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return i.querySelector("label").innerHTML=`${e.initializer.clientName} is picking a file to share`,i}function u(e,t){return document.querySelector("#forbidden").content.cloneNode(!0)}class p{constructor(e){this.kosyClient=window.parent,this.kosyApp=e}startApp(){return new Promise(((e,t)=>{window.addEventListener("message",(t=>{let i=t.data;switch(i.type){case"receive-initial-info":e(i.payload);break;case"client-has-joined":this.kosyApp.onClientHasJoined(i.payload);break;case"client-has-left":this.kosyApp.onClientHasLeft(i.payload);break;case"request-app-state":const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",payload:t});break;case"receive-message":this.kosyApp.onReceiveMessage(i.payload)}})),this._sendMessageToKosy({type:"ready-and-listening",payload:{}})}))}stopApp(){this._sendMessageToKosy({type:"stop-app",payload:{}})}relayMessage(e){this._sendMessageToKosy({type:"relay-message",payload:e})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}}var h,g=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{a(n.next(e))}catch(e){s(e)}}function l(e){try{a(n.throw(e))}catch(e){s(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}a((n=n.apply(e,t||[])).next())}))};!function(t){var i;(function(t){class i{constructor(){this.state={googleDriveFileId:null},this.kosyApi=new p({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessage:e=>{this.processMessage(e)},onRequestState:()=>this.getState()})}start(){var e;return g(this,void 0,void 0,(function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))}))}getState(){return this.state}onClientHasJoined(e){}onClientHasLeft(e){e.clientUuid!==this.initializer.clientUuid||this.state.googleDriveFileId||this.kosyApi.stopApp()}processMessage(e){return g(this,void 0,void 0,(function*(){switch(e.type){case"receive-google-drive-file-id":this.log("Received a message from Kosy: ",e),this.state.googleDriveFileId=e.payload,yield this.renderComponent()}}))}processComponentMessage(e){return g(this,void 0,void 0,(function*(){switch(e.type){case"google-drive-file-id-changed":if(e.payload){this.log("The google drive file id has changed: ",e.payload),this.kosyApi.relayMessage({type:"receive-google-drive-file-id",payload:e.payload});break}case"file-picker-opened":this.log("Open the file picker"),function(e,t){const i=window.outerWidth/2+window.screenX-t.width/2,n=window.outerHeight/2+window.screenY-t.height/2;window.open("picker.html","_blank",`fullscreen=0,menubar=0,location=0,directories=0,toolbar=0,titlebar=0,width=${t.width},height=${t.height},top=${n},left=${i}`)}(0,{width:1024,height:1024})}}))}renderComponent(){return g(this,void 0,void 0,(function*(){!function(t,i){let n=function(t){return t.googleDriveFileId?t.googleDriveUrl?e:u:t.currentClient.clientUuid==t.initializer.clientUuid?c:d}(t),o=document.getElementById("root");var s=o.cloneNode(!1);o.parentNode.replaceChild(s,o),s.appendChild(n(t,i))}({googleDriveFileId:this.state.googleDriveFileId,currentClient:this.currentClient,initializer:this.initializer,googleDriveUrl:yield s(this.state.googleDriveFileId)},(e=>this.processComponentMessage(e)))}))}log(...e){var t,i;console.log(`${null!==(i=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==i?i:"New user"} logged: `,...e)}}t.App=i,(new i).start()})((i=t.Integration||(t.Integration={})).GoogleDrive||(i.GoogleDrive={}))}(h||(h={}))})()})();