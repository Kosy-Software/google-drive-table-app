(()=>{"use strict";(()=>{function e(e,t){let i=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0),n=i.querySelector("iframe");return n.style.height=`${window.innerHeight}px`,n.src=e.googleDriveUrl,i}const t=JSON.parse('{"l":{"c":"AIzaSyA0FVCn0xu3OFqynefuTwy5-Toatw-XLyg","x":"616819909997-uh4gnbl6pjhu4p8ic3vrgof49vejr5nn.apps.googleusercontent.com"}}');var i=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))};const n=new RegExp("^(https://\\w+.google.com)"),o=new RegExp("^(https://(drive|docs).google.com)","i"),r=new RegExp("/d/([-\\w]{25,})");const s="https://www.googleapis.com/auth/drive.file",a=new Date("1970-01-01T00:00:00Z").getTime();function l(e){return i(this,void 0,void 0,(function*(){return new Promise(((t,i)=>gapi.load(e,{callback:()=>t({}),onerror:()=>i(),timeout:5e3,ontimeout:()=>i()})))}))}var c=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))};function d(e,d){let u=document.querySelector("#picking").content.cloneNode(!0),p=u.querySelector("input"),h=u.querySelector("#open-file"),g=u.querySelector("#validation-error");if(e.validationResponse.error){switch(e.validationResponse.error){case"NotFound":g.innerHTML="The file was not found";case"NotShared":g.innerHTML=`The file is not shared. Please click <a href="${function(e){let t=new URL(e.replace("/preview","/edit"));return t.searchParams.append("userstoinvite","@"),t.toString()}(e.validationResponse.url)}" target="_blank">here</a> to enable file sharing.`}p.style.color="red"}return p.value=e.validationResponse.url,p.oninput=e=>{var t;(t=p.value)&&n.test(t)?(h.removeAttribute("disabled"),p.style.color="black"):(h.setAttribute("disabled","disabled"),p.style.color="red")},h.onclick=e=>c(this,void 0,void 0,(function*(){let e=function(e){let t=e.match(r);return t&&t.length>1?t[1]:null}(p.value),n=yield function(e){return i(this,void 0,void 0,(function*(){if(!e)return null;let n=yield function(){return i(this,void 0,void 0,(function*(){let e=JSON.parse(localStorage.getItem("google_access_token")||"{}");return new Date(a+((null==e?void 0:e.expires_at)||0)-6e4)<new Date&&(e=yield function(e){return i(this,void 0,void 0,(function*(){return yield l("auth2"),yield new Promise(((t,i)=>{try{gapi.auth2.init({client_id:e,scope:s,fetch_basic_profile:!1});let o=gapi.auth2.getAuthInstance();var n=o.currentUser.get();n.hasGrantedScopes(s)?t(n.getAuthResponse(!0)):o.signIn().then((e=>t(e.getAuthResponse(!0)))).catch((e=>i(e)))}catch(e){i()}}))}))}(t.l.x),localStorage.setItem("google_access_token",JSON.stringify(e))),e}))}();if(!n)return null;yield l("client"),gapi.client.setApiKey(t.l.c),gapi.client.setToken({access_token:n.access_token});let r=`https://drive.google.com/file/d/${e}/preview`;try{let t=yield gapi.client.request({path:`https://www.googleapis.com/drive/v3/files/${e}?fields=webViewLink,shared`}),i=JSON.parse((null==t?void 0:t.body)||"{}"),n=null;return i.webViewLink&&(n=o.test(i.webViewLink)?i.webViewLink.replace("/view","/preview"):r),i.shared?{url:n}:{url:n,error:"NotShared"}}catch(e){return{url:r,error:"NotFound"}}}))}(e);d({type:"google-drive-validation-changed",payload:n})})),u.querySelector("#open-picker").onclick=e=>c(this,void 0,void 0,(function*(){d({type:"file-picker-opened",payload:{}})})),u}function u(e,t){let i=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return i.querySelector("label").innerHTML=`${e.initializer.clientName} is picking a file to share`,i}class p{constructor(e){this.kosyClient=window.parent,this.kosyApp=e}startApp(){return new Promise(((e,t)=>{window.addEventListener("message",(t=>{let i=t.data;switch(i.type){case"receive-initial-info":e(i.payload);break;case"client-has-joined":this.kosyApp.onClientHasJoined(i.payload);break;case"client-has-left":this.kosyApp.onClientHasLeft(i.payload);break;case"request-app-state":const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",payload:t});break;case"receive-message":this.kosyApp.onReceiveMessage(i.payload)}})),this._sendMessageToKosy({type:"ready-and-listening",payload:{}})}))}stopApp(){this._sendMessageToKosy({type:"stop-app",payload:{}})}relayMessage(e){this._sendMessageToKosy({type:"relay-message",payload:e})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}}var h,g=function(e,t,i,n){return new(i||(i=Promise))((function(o,r){function s(e){try{l(n.next(e))}catch(e){r(e)}}function a(e){try{l(n.throw(e))}catch(e){r(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))};!function(t){var i;(function(t){class i{constructor(){this.state={googleDriveUrl:null},this.kosyApi=new p({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessage:e=>{this.processMessage(e)},onRequestState:()=>this.getState()})}start(){var e;return g(this,void 0,void 0,(function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))}))}getState(){return this.state}onClientHasJoined(e){}onClientHasLeft(e){e.clientUuid!==this.initializer.clientUuid||this.state.googleDriveUrl||this.kosyApi.stopApp()}processMessage(e){return g(this,void 0,void 0,(function*(){switch(e.type){case"receive-google-drive-url":this.log("Received a message from Kosy: ",e),this.state.googleDriveUrl=e.payload,yield this.renderComponent()}}))}processComponentMessage(e){return g(this,void 0,void 0,(function*(){switch(e.type){case"file-picker-opened":this.log("Open the file picker"),function(e,t){const i=window.outerWidth/2+window.screenX-t.width/2,n=window.outerHeight/2+window.screenY-t.height/2;window.open("picker.html","_blank",`fullscreen=0,menubar=0,location=0,directories=0,toolbar=0,titlebar=0,width=${t.width},height=${t.height},top=${n},left=${i}`)}(0,{width:1024,height:1024});break;case"google-drive-validation-changed":let t=e.payload;this.validationResponse=t,t.error?this.renderComponent():this.kosyApi.relayMessage({type:"receive-google-drive-url",payload:t.url})}}))}renderComponent(){var t;return g(this,void 0,void 0,(function*(){!function(t,i){let n=function(t){return t.googleDriveUrl?e:t.currentClient.clientUuid==t.initializer.clientUuid?d:u}(t),o=document.getElementById("root");var r=o.cloneNode(!1);o.parentNode.replaceChild(r,o),r.appendChild(n(t,i))}({googleDriveUrl:this.state.googleDriveUrl,currentClient:this.currentClient,initializer:this.initializer,validationResponse:null!==(t=this.validationResponse)&&void 0!==t?t:{url:""}},(e=>this.processComponentMessage(e)))}))}log(...e){var t,i;console.log(`${null!==(i=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==i?i:"New user"} logged: `,...e)}}t.App=i,(new i).start()})((i=t.Integration||(t.Integration={})).GoogleDrive||(i.GoogleDrive={}))}(h||(h={}))})()})();