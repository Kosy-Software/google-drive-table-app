(()=>{"use strict";(()=>{const e=new RegExp("^(https://\\w+.google.com)"),t=new RegExp("^(https://(drive|docs).google.com)","i"),i=new RegExp("/d/([-\\w]{25,})");function n(e,n){let o=document.querySelector("#viewing").content.firstElementChild.cloneNode(!0),s=o.querySelector("iframe");return s.style.height=`${window.innerHeight}px`,s.src=(r=e.googleDriveUrl,t.test(r)?r.replace("/view","/preview"):`https://drive.google.com/file/d/${function(e){let t=e.match(i);return t&&t.length>1?t[1]:null}(r)}/preview`),o;var r}new Date("1970-01-01T00:00:00Z").getTime();var o=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};function s(t,i){let n=document.querySelector("#picking").content.cloneNode(!0),s=n.querySelector("input"),r=n.querySelector("#open-file"),a=n.querySelector("#validation-error");if(t.validationResponse.error){switch(t.validationResponse.error){case"NotShared":a.innerHTML=`The file is not shared. Please click <a href="${function(e){let t=new URL(e.replace("/preview","/edit"));return t.searchParams.append("userstoinvite","@"),t.toString()}(t.validationResponse.url)}" target="_blank">here</a> to enable file sharing.`}s.style.color="red"}return s.value=t.validationResponse.url,s.oninput=t=>{const i=s.value;var n;a.innerHTML="",(n=i)&&e.test(n)?(r.removeAttribute("disabled"),s.style.color="black"):(r.setAttribute("disabled","disabled"),s.style.color="red")},r.onclick=e=>o(this,void 0,void 0,(function*(){let e={url:s.value};i({type:"google-drive-validation-changed",payload:e})})),n.querySelector("#open-picker").onclick=e=>o(this,void 0,void 0,(function*(){i({type:"file-picker-opened",payload:{}})})),n}function r(e,t){let i=document.querySelector("#waiting").content.firstElementChild.cloneNode(!0);return i.querySelector("label").innerHTML=`${e.initializer.clientName} is picking a file to share`,i}class a{constructor(e){this.kosyClient=window.parent,this.kosyApp=e}startApp(){return new Promise(((e,t)=>{window.addEventListener("message",(t=>{let i=t.data;switch(i.type){case"receive-initial-info":e(i.payload);break;case"client-has-joined":this.kosyApp.onClientHasJoined(i.payload);break;case"client-has-left":this.kosyApp.onClientHasLeft(i.clientUuid);break;case"get-app-state":const t=this.kosyApp.onRequestState();this._sendMessageToKosy({type:"receive-app-state",payload:t,clientUuids:i.clientUuids});break;case"set-app-state":this.kosyApp.onProvideState(i.state);break;case"receive-message":this.kosyApp.onReceiveMessage(i.payload)}})),this._sendMessageToKosy({type:"ready-and-listening"})}))}stopApp(){this._sendMessageToKosy({type:"stop-app"})}relayMessage(e){this._sendMessageToKosy({type:"relay-message",payload:e})}_sendMessageToKosy(e){this.kosyClient.postMessage(e,"*")}}var l,c=function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{l(n.next(e))}catch(e){s(e)}}function a(e){try{l(n.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,a)}l((n=n.apply(e,t||[])).next())}))};!function(e){var t;(function(e){class t{constructor(){this.state={googleDriveUrl:null},this.kosyApi=new a({onClientHasJoined:e=>this.onClientHasJoined(e),onClientHasLeft:e=>this.onClientHasLeft(e),onReceiveMessage:e=>{this.processMessage(e)},onRequestState:()=>this.getState(),onProvideState:e=>this.setState(e)})}start(){var e;return c(this,void 0,void 0,(function*(){let t=yield this.kosyApi.startApp();this.initializer=t.clients[t.initializerClientUuid],this.currentClient=t.clients[t.currentClientUuid],this.state=null!==(e=t.currentAppState)&&void 0!==e?e:this.state,this.renderComponent(),window.addEventListener("message",(e=>{this.processComponentMessage(e.data)}))}))}getState(){return this.state}setState(e){this.state=e}onClientHasJoined(e){}onClientHasLeft(e){e!==this.initializer.clientUuid||this.state.googleDriveUrl||this.kosyApi.stopApp()}processMessage(e){return c(this,void 0,void 0,(function*(){switch(e.type){case"receive-google-drive-url":this.log("Received a message from Kosy: ",e),this.state.googleDriveUrl=e.payload,yield this.renderComponent()}}))}processComponentMessage(e){return c(this,void 0,void 0,(function*(){switch(e.type){case"file-picker-opened":this.log("Open the file picker"),function(e,t){const i=window.outerWidth/2+window.screenX-t.width/2,n=window.outerHeight/2+window.screenY-t.height/2;window.open("picker.html","_blank",`fullscreen=0,menubar=0,location=0,directories=0,toolbar=0,titlebar=0,width=${t.width},height=${t.height},top=${n},left=${i}`)}(0,{width:1024,height:1024});break;case"google-drive-validation-changed":let t=e.payload;this.validationResponse=t,t.error?this.renderComponent():this.kosyApi.relayMessage({type:"receive-google-drive-url",payload:t.url})}}))}renderComponent(){var e;return c(this,void 0,void 0,(function*(){!function(e,t){let i=function(e){return e.googleDriveUrl?n:e.currentClient.clientUuid==e.initializer.clientUuid?s:r}(e),o=document.getElementById("root");var a=o.cloneNode(!1);o.parentNode.replaceChild(a,o),a.appendChild(i(e,t))}({googleDriveUrl:this.state.googleDriveUrl,currentClient:this.currentClient,initializer:this.initializer,validationResponse:null!==(e=this.validationResponse)&&void 0!==e?e:{url:""}},(e=>this.processComponentMessage(e)))}))}log(...e){var t,i;console.log(`${null!==(i=null===(t=this.currentClient)||void 0===t?void 0:t.clientName)&&void 0!==i?i:"New user"} logged: `,...e)}}e.App=t,(new t).start()})((t=e.Integration||(e.Integration={})).GoogleDrive||(t.GoogleDrive={}))}(l||(l={}))})()})();